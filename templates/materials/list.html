{% extends "base.html" %}

{% block title %}Materials - Construction Management{% endblock %}

{% block content %}
<div class="home-page">
    <div class="home-header">
        <h1>Material Management</h1>
        <button class="btn btn-primary btn-large" onclick="showNewJobModal()">+ New Job</button>
    </div>

    {% if jobs %}
    <div class="job-list" id="jobList">
        {% for job in jobs %}
        <a href="/materials/job/{{ job.id }}" class="job-card" id="job-card-{{ job.id }}">
            <div class="job-card-name">{{ job.name }}</div>
            <div class="job-card-meta">
                <span class="status-badge status-{{ job.status|lower|replace(' ', '-') }}">{{ job.status }}</span>
                <span class="job-card-date">Updated {{ job.updated_at }}</span>
                {% if current_user.role == 'owner' %}
                <button class="btn-delete-job" onclick="deleteJob(event, {{ job.id }})" title="Delete job">&times;</button>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state" id="emptyState">
        <p>No jobs yet. Click <strong>+ New Job</strong> to get started.</p>
    </div>
    {% endif %}
</div>

<!-- New Job Modal -->
<div id="newJobModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)hideNewJobModal()">
    <div class="modal">
        <h2>Create New Job</h2>
        <form onsubmit="createJob(event)">
            <label for="jobName">Job Name</label>
            <input type="text" id="jobName" placeholder="e.g. Building A - Phase 2" autofocus required>

            <label for="jobAddress">Address</label>
            <input type="text" id="jobAddress" placeholder="123 Main St">

            <div class="modal-row">
                <div class="modal-field">
                    <label for="jobCity">City</label>
                    <input type="text" id="jobCity" placeholder="City">
                </div>
                <div class="modal-field modal-field-sm">
                    <label for="jobState">State</label>
                    <input type="text" id="jobState" placeholder="OK" maxlength="2">
                </div>
                <div class="modal-field modal-field-sm">
                    <label for="jobZip">Zip Code</label>
                    <input type="text" id="jobZip" placeholder="73034" maxlength="5">
                </div>
            </div>

            <div class="modal-row">
                <div class="modal-field">
                    <label for="jobTaxRate">Tax Rate %</label>
                    <input type="number" id="jobTaxRate" placeholder="8.625" step="0.001" min="0">
                </div>
                <div class="modal-field">
                    <span id="taxLookupInfo" class="tax-lookup-info"></span>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideNewJobModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Job</button>
            </div>
        </form>
    </div>
</div>

<script>
function showNewJobModal() {
    document.getElementById('newJobModal').style.display = 'flex';
    document.getElementById('jobName').focus();
}
function hideNewJobModal() {
    document.getElementById('newJobModal').style.display = 'none';
    document.getElementById('jobName').value = '';
    document.getElementById('jobAddress').value = '';
    document.getElementById('jobCity').value = '';
    document.getElementById('jobState').value = '';
    document.getElementById('jobZip').value = '';
    document.getElementById('jobTaxRate').value = '';
    document.getElementById('taxLookupInfo').textContent = '';
}
async function createJob(e) {
    e.preventDefault();
    const name = document.getElementById('jobName').value.trim();
    if (!name) return;
    const payload = {
        name,
        address: document.getElementById('jobAddress').value.trim(),
        city: document.getElementById('jobCity').value.trim(),
        state: document.getElementById('jobState').value.trim(),
        zip_code: document.getElementById('jobZip').value.trim(),
    };
    const taxVal = document.getElementById('jobTaxRate').value;
    if (taxVal !== '') payload.tax_rate = parseFloat(taxVal) || 0;
    const res = await fetch('/api/jobs', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    if (res.ok) {
        const data = await res.json();
        window.location.href = '/materials/job/' + data.id;
    } else {
        alert('Failed to create job.');
    }
}

async function deleteJob(event, jobId) {
    event.preventDefault();
    event.stopPropagation();
    if (!confirm('Are you sure you want to delete this job? This cannot be undone.')) return;
    const res = await fetch('/api/job/' + jobId, { method: 'DELETE' });
    if (res.ok) {
        const card = document.getElementById('job-card-' + jobId);
        if (card) {
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => {
                card.remove();
                const jobList = document.getElementById('jobList');
                if (jobList && jobList.children.length === 0) {
                    jobList.remove();
                    const container = document.querySelector('.home-page');
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    empty.innerHTML = '<p>No jobs yet. Click <strong>+ New Job</strong> to get started.</p>';
                    container.appendChild(empty);
                }
            }, 300);
        }
    }
}

document.getElementById('jobZip').addEventListener('blur', lookupZip);
document.getElementById('jobZip').addEventListener('input', function() {
    if (this.value.trim().length === 5) lookupZip();
});
async function lookupZip() {
    const zip = document.getElementById('jobZip').value.trim();
    if (zip.length < 5) return;
    try {
        const res = await fetch('/api/tax-lookup/' + zip);
        const info = await res.json();
        if (info.out_of_state) {
            document.getElementById('taxLookupInfo').textContent = 'Out-of-state shipping fee applies';
            document.getElementById('taxLookupInfo').className = 'tax-lookup-info out-of-state';
            if (info.tax_rate) document.getElementById('jobTaxRate').value = info.tax_rate;
            if (info.state) document.getElementById('jobState').value = info.state;
            if (info.city) document.getElementById('jobCity').value = info.city;
        } else if (info.tax_rate) {
            document.getElementById('jobTaxRate').value = info.tax_rate;
            if (info.state) document.getElementById('jobState').value = info.state;
            if (info.city) document.getElementById('jobCity').value = info.city;
            document.getElementById('taxLookupInfo').textContent = info.city ? info.city + ', ' + info.state + ' - ' + info.tax_rate + '%' : info.tax_rate + '%';
            document.getElementById('taxLookupInfo').className = 'tax-lookup-info';
        }
    } catch (err) { console.error('Tax lookup failed:', err); }
}
</script>
{% endblock %}
