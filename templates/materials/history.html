{% extends "base.html" %}

{% block title %}History - {{ job.name }}{% endblock %}

{% block header %}
<div class="page-top-bar">
    <div class="page-top-actions">
        <a href="/materials/job/{{ job.id }}" class="btn btn-secondary">Back to Job</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="history-page" data-job-id="{{ job.id }}">
    <h1>Version History: {{ job.name }}</h1>
    <p class="history-subtitle">Every save creates a snapshot. You can preview or revert to any previous version.</p>

    <div id="versionList" class="version-list">
        <p class="loading">Loading versions...</p>
    </div>
</div>

<div id="previewModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closePreview()">
    <div class="modal modal-wide">
        <div class="modal-header">
            <h2 id="previewTitle">Version Preview</h2>
            <button class="btn btn-secondary" onclick="closePreview()">Close</button>
        </div>
        <div id="previewContent" class="preview-content"></div>
    </div>
</div>

<script>
window.JOB_ID = {{ job.id }};

document.addEventListener('DOMContentLoaded', loadVersions);

async function loadVersions() {
    const res = await fetch(`/api/job/${window.JOB_ID}/versions`);
    const versions = await res.json();
    const container = document.getElementById('versionList');

    if (versions.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No versions yet.</p></div>';
        return;
    }

    container.innerHTML = versions.map(v => `
        <div class="version-card">
            <div class="version-info">
                <div class="version-desc">${escapeHtml(v.description)}</div>
                <div class="version-date">${v.created_at}</div>
            </div>
            <div class="version-actions">
                <button class="btn btn-secondary btn-small" onclick="previewVersion(${v.id})">Preview</button>
                <button class="btn btn-warning btn-small" onclick="revertVersion(${v.id})">Revert</button>
            </div>
        </div>
    `).join('');
}

async function previewVersion(vid) {
    const res = await fetch(`/api/job/${window.JOB_ID}/versions/${vid}`);
    const data = await res.json();
    const snap = data.snapshot;

    document.getElementById('previewTitle').textContent = `Version: ${data.description} (${data.created_at})`;

    let html = '<table class="data-table preview-table"><thead><tr>';
    html += '<th>Line #</th><th>Stock/NS</th><th>SKU</th><th>Description</th>';
    html += '<th>Quote QTY</th><th>QTY Ordered</th><th>Price Per</th><th>Total Net Price</th>';
    html += '</tr></thead><tbody>';

    for (const item of snap.line_items) {
        const total = (item.qty_ordered || 0) * (item.price_per || 0);
        html += `<tr>
            <td>${item.line_number}</td>
            <td>${escapeHtml(item.stock_ns || '')}</td>
            <td>${escapeHtml(item.sku || '')}</td>
            <td>${escapeHtml(item.description || '')}</td>
            <td>${item.quote_qty}</td>
            <td>${item.qty_ordered}</td>
            <td>${formatMoney(item.price_per)}</td>
            <td class="computed">${formatMoney(total)}</td>
        </tr>`;
    }
    html += '</tbody></table>';

    document.getElementById('previewContent').innerHTML = html;
    document.getElementById('previewModal').style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

async function revertVersion(vid) {
    if (!confirm('Revert to this version? Current data will be saved as a snapshot first.')) return;
    const res = await fetch(`/api/job/${window.JOB_ID}/versions/${vid}/revert`, { method: 'POST' });
    if (res.ok) {
        alert('Reverted successfully.');
        window.location.href = `/materials/job/${window.JOB_ID}`;
    } else {
        alert('Revert failed.');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMoney(val) {
    return '$' + (val || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
</script>
{% endblock %}
